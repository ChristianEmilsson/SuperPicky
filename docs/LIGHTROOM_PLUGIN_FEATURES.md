# 🦆 SuperPicky Lightroom 插件功能分析

**版本**: v3.9.3  
**更新日期**: 2026-01-18

---

## 📋 目前实现的功能

### 1. 核心识别功能 ✅

| 功能 | 状态 | 说明 |
|------|------|------|
| **鸟类识别** | ✅ 已实现 | 调用本地 API 识别照片中的鸟类 |
| **YOLO 检测** | ✅ 已实现 | 自动检测并裁剪鸟类区域，提高识别准确率 |
| **GPS 位置读取** | ✅ 已实现 | 从照片 EXIF 读取 GPS 坐标 |
| **eBird 地理过滤** | ✅ 已实现 | 根据地理位置筛选可能出现的鸟种 |
| **Top-K 结果** | ✅ 已实现 | 返回多个识别候选（可配置 1-10 个） |

### 2. 元数据写入 ✅

| 功能 | 状态 | 写入位置 |
|------|------|----------|
| **鸟种名称（中文）** | ✅ 已实现 | IPTC Title 标题 |
| **学名 + 英文名** | ✅ 已实现 | IPTC Caption 题注 |
| **鸟种描述** | ⚠️ 部分实现 | Caption 中附加描述 |

### 3. 用户界面配置 ✅

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| API 地址 | `http://127.0.0.1:5156` | 可自定义服务器地址 |
| 返回结果数 | 3 | 滑块选择 1-10 |
| YOLO 检测 | ✅ 开启 | 复选框控制 |
| GPS 定位 | ✅ 开启 | 复选框控制 |
| 自动写入 EXIF | ✅ 开启 | 复选框控制 |

### 4. 工作流程

```
Lightroom 选中照片
     ↓
获取原图路径（不导出压缩）
     ↓
调用 SuperPicky API (http://127.0.0.1:5156/recognize)
     ├─ YOLO 检测鸟类位置
     ├─ GPS 读取拍摄坐标
     ├─ eBird 地理过滤
     └─ AI 鸟类识别
     ↓
显示识别结果对话框
     ↓
用户确认后写入 EXIF 元数据
```

---

## ⚠️ 当前限制

| 限制 | 说明 | 原因 |
|------|------|------|
| **单张处理** | 一次只能识别 1 张照片 | 避免长时间阻塞 Lightroom |
| **需要 API 服务** | 必须先启动 `birdid_server.py` | 识别在后端运行 |
| **无批量确认** | 每张都需弹窗确认 | 用户控制写入 |
| **国家列表庞大** | 包含 240+ 国家代码 | 大部分用不到 |

---

## 🚀 可扩展的功能

### A. 高优先级（用户体验提升）

#### 1. 批量识别支持 🔥
```
当前: 一次只能处理 1 张照片
扩展: 支持选中多张照片批量识别

实现方案:
- 移除 nPhotos > 1 的限制
- 使用进度条显示处理进度
- 完成后显示摘要结果
- 可选: 静默模式（自动写入最高置信度的结果）
```

#### 2. 智能自动写入模式 ⚡
```
当前: 每张照片都需用户确认
扩展: 置信度阈值自动写入

实现方案:
- 添加 "置信度阈值" 配置项（如 80%）
- 置信度 >= 阈值: 自动写入，不弹窗
- 置信度 < 阈值: 弹窗确认
- 日志记录所有操作
```

#### 3. 结果选择对话框 📋
```
当前: 只显示第一名结果
扩展: 显示所有候选，用户可选择

实现方案:
- 列表显示 Top-K 结果
- 显示中文名、英文名、置信度
- 用户点击选择要写入的结果
- 支持 "跳过此照片" 按钮
```

### B. 中优先级（功能增强）

#### 4. 写入更多元数据字段 📝
```
当前写入:
- Title: 中文名

可扩展:
- Keywords/标签: 中文名, 英文名, 科属
- Subject: 学名
- Location: GPS 所在地区名称
- Headline: 英文名 (EN)
- Description: 鸟种详细描述

实现方案:
- 添加 "元数据字段选择" 配置界面
- 复选框选择要写入哪些字段
- 调用 API 获取详细鸟种信息
```

#### 5. eBird 国家/地区快捷选择 🌍
```
当前: 依赖 GUI 配置文件或 GPS
扩展: 插件内直接选择国家/地区

实现方案:
- 添加 "国家" 下拉列表（常用国家）
- 添加 "地区" 联动下拉列表
- 减少国家列表到常用 20 个 + "更多"
- 保存用户选择到配置
```

#### 6. 识别历史记录 📊
```
功能: 记录每次识别结果

实现方案:
- 本地 JSON 文件存储历史
- 记录: 文件名、识别结果、置信度、时间
- 可用于后续分析和统计
```

### C. 低优先级（高级功能）

#### 7. 离线模式提示 🔌
```
功能: API 不可用时的友好提示

实现方案:
- 健康检查失败时提供更多帮助
- 显示启动 API 的具体命令
- 可选: 一键启动 API（调用系统命令）
```

#### 8. 多语言支持 🌐
```
功能: 界面支持中英文切换

实现方案:
- 提取所有字符串到语言表
- 根据 Lightroom 语言设置自动切换
- 或添加语言选择配置项
```

#### 9. 识别结果预览 👁️
```
功能: 显示 YOLO 裁剪后的鸟类区域

实现方案:
- API 返回裁剪后的 Base64 图片
- 在确认对话框中显示预览
- 帮助用户判断识别是否准确
```

#### 10. 与 Lightroom 关键词库集成 🏷️
```
功能: 自动关联已有的鸟类关键词

实现方案:
- 读取 Lightroom 关键词库
- 匹配识别结果与已有关键词
- 自动应用对应的关键词层级
```

---

## 📐 技术架构

```
┌─────────────────────────────────────────────────────────────┐
│                   Adobe Lightroom Classic                   │
│                                                             │
│  ┌───────────────────────────────────────────────────────┐  │
│  │         SuperBirdIDPlugin.lrplugin (v3.9.3)           │  │
│  │  ┌─────────────────┐  ┌──────────────────────────┐    │  │
│  │  │    Info.lua     │  │ SuperBirdIDExport...lua │    │  │
│  │  │  (插件元信息)   │  │  (核心识别逻辑)          │    │  │
│  │  └─────────────────┘  └──────────────────────────┘    │  │
│  └───────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              ↓  HTTP POST (JSON)
┌─────────────────────────────────────────────────────────────┐
│        SuperPicky BirdID API (http://127.0.0.1:5156)        │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │ birdid_server.py│→ │ birdid/bird_identifier.py      │   │
│  │ (Flask API)     │  │ (YOLO + AI 识别引擎)            │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
│           ↓                          ↓                      │
│  ┌─────────────────┐  ┌─────────────────────────────────┐   │
│  │/health          │  │/recognize - 识别鸟类            │   │
│  │/exif/write-title│  │/exif/write-caption             │   │
│  └─────────────────┘  └─────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 📁 文件结构

```
SuperPicky2026/
├── SuperBirdIDPlugin.lrplugin/
│   ├── Info.lua                       # 插件元信息 (版本 3.9.3)
│   ├── PluginInit.lua                 # 初始化脚本
│   └── SuperBirdIDExportServiceProvider.lua  # 核心逻辑 (~680行)
│
├── birdid_server.py                   # API 服务器
├── birdid/
│   ├── bird_identifier.py             # 识别引擎
│   ├── ebird_country_filter.py        # eBird 地理过滤
│   └── data/                          # 数据文件
│
└── docs/
    ├── API使用说明.md                 # API 接口文档
    └── 使用说明_v2.0.md               # 用户使用说明
```

---

## 🎯 推荐开发优先级

### 第一阶段（核心增强）
1. **批量识别支持** - 最常见的用户需求
2. **智能自动写入** - 减少重复确认操作

### 第二阶段（体验优化）
3. **结果选择对话框** - 更精细的用户控制
4. **写入更多元数据** - Keywords, Description 等

### 第三阶段（完善功能）
5. **国家/地区快捷选择** - 简化配置
6. **识别结果预览** - 可视化确认
