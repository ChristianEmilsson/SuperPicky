# 🦆 SuperBirdID Lightroom 插件 v2.0 - SuperBirdID 本地版

## 📋 版本说明

**v2.0.0** - 完全移除守护进程，直接调用本地 SuperBirdID API

### 主要改进：
- ✅ **无需守护进程** - 移除了 `superbirdid_daemon.py`
- ✅ **无需导出图片** - 直接使用原图路径，不压缩
- ✅ **速度提升 10 倍** - 本地 API 调用 < 1 秒
- ✅ **更高准确度** - 使用原图识别，不是 640px 压缩图
- ✅ **自动 YOLO 检测** - SuperBirdID API 内置
- ✅ **自动 GPS 读取** - 从 EXIF 自动提取

---

## 🚀 快速开始

### 1️⃣ 前提条件

确保 **SuperBirdID API** 已在本地运行：

```bash
# 在 SuperBirdID 目录启动 API
cd /path/to/SuperBirdID
python SuperBirdID_API.py --host 127.0.0.1 --port 5156
```

验证 API 是否运行：
```bash
curl http://127.0.0.1:5156/health
# 应返回: {"status":"ok", ...}
```

### 2️⃣ 安装插件

1. 将 `SuperBirdIDPlugin.lrplugin` 文件夹复制到 Lightroom 插件目录
2. 在 Lightroom 中：`文件` → `插件管理器` → `添加`
3. 选择 `SuperBirdIDPlugin.lrplugin` 文件夹

### 3️⃣ 使用插件

1. **选择一张鸟类照片**（仅支持单张）
2. **右键** → `导出` → 选择 `SuperBirdID 识别`
3. **配置选项**：
   - API 地址：`http://127.0.0.1:5156`（默认）
   - 返回结果数：1-10（推荐 3）
   - 启用 YOLO 检测：✓
   - 启用 GPS 定位：✓
   - 自动写入 EXIF：✓
4. **点击导出** → 等待识别完成

---

## ⚙️ 配置说明

### API 设置

| 选项 | 默认值 | 说明 |
|------|--------|------|
| API 地址 | `http://127.0.0.1:5156` | SuperBirdID API 服务地址 |
| 返回结果数 | `3` | 返回 top-K 识别结果 |
| 启用 YOLO 检测 | `✓` | 使用 YOLO 预检测鸟类位置 |
| 启用 GPS 定位 | `✓` | 从 EXIF 读取 GPS 辅助识别 |
| 自动写入 EXIF | `✓` | 识别后自动写入鸟种名称到标题 |

---

## 🔧 工作流程

```
Lightroom 选中照片
    ↓
获取原图路径（不导出）
    ↓
调用本地 SuperBirdID API
    ├─ YOLO 检测鸟类
    ├─ GPS 读取位置
    └─ 识别鸟类种类
    ↓
返回识别结果
    ↓
写入 EXIF 标题（可选）
```

**识别时间**：< 1 秒（本地 API）

---

## 📊 与旧版对比

| 功能 | v1.x（远程 API + Daemon） | v2.0（本地 API） |
|------|--------------------------|-----------------|
| **速度** | 5-30 秒 | < 1 秒 |
| **图片质量** | 640px 压缩 | 原图 |
| **需要守护进程** | ✓ | ✗ |
| **需要导出图片** | ✓ | ✗ |
| **网络依赖** | 需要联网 | 纯本地 |
| **API 费用** | 收费 | 免费 |
| **隐私** | 上传云端 | 完全本地 |

---

## 🆘 故障排除

### ❌ 错误：无法连接到 SuperBirdID API

**原因**：SuperBirdID API 未启动或地址错误

**解决**：
```bash
# 检查 API 是否运行
curl http://127.0.0.1:5156/health

# 如果没有返回，启动 API
cd /path/to/SuperBirdID
python SuperBirdID_API.py --host 127.0.0.1 --port 5156
```

### ❌ 错误：无法访问照片文件

**原因**：Lightroom 无法读取原图路径

**解决**：
- 确保照片文件存在且未被移动
- 检查文件权限
- 确保照片在 Lightroom 目录中

### ⚠️ 识别失败

**可能原因**：
- 照片中没有清晰的鸟类
- 图片文件损坏
- SuperBirdID 模型未正确加载

**解决**：
- 检查 SuperBirdID API 日志
- 确保照片中有明显的鸟类
- 重启 SuperBirdID API

---

## 📝 技术细节

### API 请求格式

```json
{
  "image_path": "/absolute/path/to/photo.jpg",
  "use_yolo": true,
  "use_gps": true,
  "top_k": 3
}
```

### API 响应格式

```json
{
  "success": true,
  "results": [
    {
      "cn_name": "白头鹎",
      "en_name": "Light-vented Bulbul",
      "scientific_name": "Pycnonotus sinensis",
      "confidence": 95.5
    }
  ],
  "yolo_info": "YOLO检测: 1个目标, 置信度0.95",
  "gps_info": {
    "latitude": 39.123,
    "longitude": 116.456,
    "region": "中国"
  }
}
```

---

## 🔄 升级说明

### 从 v1.x 升级到 v2.0

1. **停止旧守护进程**（如果在运行）：
   ```bash
   ./stop_daemon.sh
   ```

2. **备份已完成**：旧文件在 `backup_daemon/` 目录

3. **启动 SuperBirdID API**（替代守护进程）：
   ```bash
   cd /path/to/SuperBirdID
   python SuperBirdID_API.py --host 127.0.0.1 --port 5156
   ```

4. **重新加载 Lightroom 插件**

---

## 💡 最佳实践

1. **保持 SuperBirdID API 后台运行**
   ```bash
   # macOS/Linux 后台运行
   nohup python SuperBirdID_API.py --host 127.0.0.1 --port 5156 > /tmp/api.log 2>&1 &
   ```

2. **使用原图识别** - 无需预先裁剪或压缩

3. **批量处理** - 虽然插件一次只处理一张，但可以通过循环选择处理多张

4. **GPS 信息** - 拍摄时开启相机 GPS 可提高识别准确度

---

## 📚 相关资源

- **SuperBirdID API 文档**：查看 `API使用说明.md`
- **旧版备份**：`backup_daemon/` 目录
- **日志位置**：Lightroom 插件管理器 → 查看日志

---

## 🎉 总结

**v2.0 的核心改进**：

- 🚀 **极速识别** - 本地 API < 1 秒
- 🖼️ **原图质量** - 不压缩，识别更准确
- 🧹 **架构简化** - 移除守护进程，减少 80% 代码
- 💰 **完全免费** - 无 API 调用费用
- 🔒 **隐私保护** - 照片不离开本地

现在开始享受本地化、高速的鸟类识别体验吧！🦆
